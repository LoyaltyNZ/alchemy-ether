name: PRChecks3

on:
    push:
      branches:
        - test

jobs:

  build:
    runs-on: ubuntu-latest
    
    services:
      rabbitmq:
        image: rabbitmq:3.8.14-management
        ports:
          - 5672:5672
          - 15672:15672
      memcached:
        image: memcached:1.6.12
        ports:
          - 11211:11211
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 8.15.1
      uses: actions/setup-node@v2
      with:
        node-version: 8.15.1

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '2.x'        

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
      
    - name: Cache dependencies
      uses: actions/cache@v2
      with:
        path: ~/.npm
        key: ${{ runner.OS }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.OS }}-node-
          
    - name: Install dependencies
      run: npm ci
      
    - name: Set environment variables
      run: |
        export CXX="g++-4.8"
        export NODE_TLS_REJECT_UNAUTHORIZED=0
        
    - name: Run tests
      run: npm test