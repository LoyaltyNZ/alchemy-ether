<!DOCTYPE html>

<html>
<head>
  <title>service_connection_manager.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="service.html">
                  service.coffee
                </a>
              
                
                <a class="source" href="service_connection_manager.html">
                  service_connection_manager.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>service_connection_manager.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>bb = <span class="hljs-built_in">require</span> <span class="hljs-string">"bluebird"</span>
amqp = <span class="hljs-built_in">require</span>(<span class="hljs-string">"amqplib"</span>)
_ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Throwing the NAckError will cause the message to be put back on the queue.
This is VERY DANGEROUS because if your service can never NAck the message
it may live forever and cause all sorts of havoc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NAckError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Error</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@name</span> = <span class="hljs-string">"NAckError"</span>
    <span class="hljs-property">@message</span> = <span class="hljs-string">"NAck the Message"</span>
    Error.captureStackTrace(<span class="hljs-keyword">this</span>, NAckError)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceConnectionManager</span></span>
  <span class="hljs-property">@NAckError</span> = NAckError

  log : <span class="hljs-function"><span class="hljs-params">(message)</span> -&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"<span class="hljs-subst">#{(<span class="hljs-keyword">new</span> Date()).toISOString()}</span> - <span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span> - <span class="hljs-subst">#{message}</span>"</span>

  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@ampq_uri</span>, <span class="hljs-property">@uuid</span>, <span class="hljs-property">@service_queue_name</span>, <span class="hljs-property">@service_handler</span>, <span class="hljs-property">@response_queue_name</span>, <span class="hljs-property">@response_handler</span>, <span class="hljs-property">@returned_handler</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The states are:
                restarting
                 A      |
                error  start()
                 |      |
    starting —&gt; started –|
       A             |      |
     start()        stop()  |
       |             V      |
    stopped   &lt;-  stopping  |
       |                    |
       |——————–|
     kill()
       |
    killing
       |
       V
     dead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-property">@state</span> = <span class="hljs-string">'stopped'</span>
    <span class="hljs-property">@in_flight_messages</span> = {}

  <span class="hljs-attribute">get_connection</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>can only get a connection if starting or started</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span>: #get_connection rejected state <span class="hljs-subst">#{<span class="hljs-property">@state</span>}</span>"</span>) <span class="hljs-keyword">if</span> !<span class="hljs-property">@in_state</span>([<span class="hljs-string">'started'</span>, <span class="hljs-string">'starting'</span>])

    <span class="hljs-keyword">return</span> <span class="hljs-property">@_connection</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@_connection</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>@log “creating connection”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@_connection</span> = amqp.connect(<span class="hljs-property">@ampq_uri</span>)
    .<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-params">(connection)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>@log “created connection”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      connection.<span class="hljs-literal">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(error)</span> =&gt;</span>
        <span class="hljs-property">@log</span>(<span class="hljs-string">"AMQP Error connection error - <span class="hljs-subst">#{error}</span> - <span class="hljs-subst">#{error.stack || <span class="hljs-string">''</span>}</span>"</span>)
        <span class="hljs-property">@_connection</span> = <span class="hljs-literal">null</span>
      )
      connection.<span class="hljs-literal">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">=&gt;</span>
        <span class="hljs-property">@_connection</span> = <span class="hljs-literal">null</span> <span class="hljs-comment">#connection closed</span>
      )
      connection
    )

  <span class="hljs-attribute">get_service_channel</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>reject if not started, starting, or stopping to reply to messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span>: #get_service_channel rejected state <span class="hljs-subst">#{<span class="hljs-property">@state</span>}</span>"</span>) <span class="hljs-keyword">if</span> !<span class="hljs-property">@in_state</span>([<span class="hljs-string">'started'</span>,<span class="hljs-string">'starting'</span>,<span class="hljs-string">'stopping'</span>])

    <span class="hljs-keyword">return</span> <span class="hljs-property">@_service_channel</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@_service_channel</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>@log “creating service channel”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-property">@_service_channel</span> = <span class="hljs-property">@get_connection</span>()
    .<span class="hljs-keyword">then</span>( <span class="hljs-function"><span class="hljs-params">(connection)</span> =&gt;</span>
      connection.createChannel()
    )
    .<span class="hljs-keyword">then</span>( <span class="hljs-function"><span class="hljs-params">(service_channel)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>@log “created service channel”
<a href="http://www.mariuszwojcik.com/2014/05/19/how-to-choose-prefetch-count-value-for-rabbitmq/">http://www.mariuszwojcik.com/2014/05/19/how-to-choose-prefetch-count-value-for-rabbitmq/</a>
prefetch will grab a number of un ack’ed messages from the queue
since basically the first thing we do is ack a message this number can be quite low</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      service_channel.prefetch <span class="hljs-number">20</span>

      service_channel.<span class="hljs-literal">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(error)</span> =&gt;</span>
        <span class="hljs-property">@log</span> <span class="hljs-string">"Service Channel Errored <span class="hljs-subst">#{error}</span>, <span class="hljs-subst">#{error.stack}</span>"</span>
        <span class="hljs-property">@_service_channel</span> = <span class="hljs-literal">null</span>
      )

      service_channel.<span class="hljs-literal">on</span>(<span class="hljs-string">'return'</span>, <span class="hljs-function"><span class="hljs-params">(message)</span> =&gt;</span>
        <span class="hljs-property">@log</span> <span class="hljs-string">"Message Returned to Channel"</span>
        <span class="hljs-property">@returned_handler</span>(message)
      )

      service_channel.<span class="hljs-literal">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">=&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>@log “Service Channel Closed”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@_service_channel</span> = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@state</span> == <span class="hljs-string">'started'</span> <span class="hljs-comment"># i.e. it should be currently running</span>
          <span class="hljs-property">@log</span> <span class="hljs-string">"AMQP Service Channel closed, restarting service"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>then restart</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@restart</span>()
        <span class="hljs-keyword">else</span>
          <span class="hljs-property">@log</span> <span class="hljs-string">"Service Channel stopped"</span>
      )

      <span class="hljs-property">@create_response_queue</span>(service_channel)
      .<span class="hljs-keyword">then</span>( <span class="hljs-function">=&gt;</span> <span class="hljs-property">@create_service_queue</span>(service_channel))
      .<span class="hljs-keyword">then</span>( <span class="hljs-function">-&gt;</span> service_channel) <span class="hljs-comment">#return the service channel</span>
    )

  <span class="hljs-attribute">create_response_queue</span>: <span class="hljs-function"><span class="hljs-params">(service_channel)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@response_queue_name</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>@log “Creating response queue”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">      <span class="hljs-title">fn</span> = <span class="hljs-params">(msg)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>@log “recieved response message ID <code>#{JSON.stringify(msg.properties)}</code>“</p>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>response immediately acks because no other service is listening to it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service_channel.ack(msg)
        <span class="hljs-property">@response_handler</span>(msg)


      service_channel.assertQueue(<span class="hljs-property">@response_queue_name</span>, {<span class="hljs-attribute">expires</span>: <span class="hljs-number">1000</span>})
      .<span class="hljs-keyword">then</span>( <span class="hljs-function"><span class="hljs-params">(response_queue)</span> =&gt;</span>
        service_channel.consume(<span class="hljs-property">@response_queue_name</span>, fn)
      )
    <span class="hljs-keyword">else</span>
      bb.<span class="hljs-keyword">try</span>( <span class="hljs-function">-&gt;</span> )

  <span class="hljs-attribute">create_service_queue</span>: <span class="hljs-function"><span class="hljs-params">(service_channel)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@service_queue_name</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>@log “Creating service queue”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">      <span class="hljs-title">fn</span> = <span class="hljs-params">(msg)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>@log “recieved service message ID <code>#{msg.properties.messageId}</code>“</p>
<p>Conditions</p>
<ol>
<li>The Service Function Succeeds</li>
<li>The Service Function Has an Unknown Error</li>
<li>The Service has a NAckError Error</li>
<li>The Service is killed or dies while processing the message</li>
</ol>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <ol>
<li>will ack the message</li>
<li>will log the error then ack the message</li>
<li>will log the error then nack the message (so that another service can handle it later)</li>
<li>will cause the service channel to die which will not ack the message</li>
</ol>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>console.log ‘add message’, _.keys(@in_flight_messages).length</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@in_flight_messages</span>[msg.properties.messageId] = bb.<span class="hljs-keyword">try</span>( <span class="hljs-function">=&gt;</span> <span class="hljs-property">@service_handler</span>(msg))
        .<span class="hljs-keyword">then</span>( <span class="hljs-function">-&gt;</span>
          service_channel.ack(msg)
        )
        .<span class="hljs-keyword">catch</span>( NAckError, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
          <span class="hljs-built_in">console</span>.error <span class="hljs-string">"NACKed MESSAGE"</span>, err.stack
          service_channel.nack(msg)
        )
        .<span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If the service has not handled this error, then remove it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-built_in">console</span>.error <span class="hljs-string">"Service Channel Error"</span>, err.stack
          service_channel.ack(msg)
        )
        .<span class="hljs-keyword">finally</span>( <span class="hljs-function">=&gt;</span>
          <span class="hljs-keyword">delete</span> <span class="hljs-property">@in_flight_messages</span>[msg.properties.messageId]</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>console.log ‘remove message’, _.keys(@in_flight_messages).length</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        )

      service_channel.assertQueue(<span class="hljs-property">@service_queue_name</span>, {<span class="hljs-attribute">durable</span>: <span class="hljs-literal">true</span>})
      .<span class="hljs-keyword">then</span>( <span class="hljs-function">=&gt;</span>
        service_channel.consume(<span class="hljs-property">@service_queue_name</span>, fn)
      )
      .<span class="hljs-keyword">then</span>( <span class="hljs-function"><span class="hljs-params">(ret)</span> =&gt;</span>
        <span class="hljs-property">@_service_queue_consumer_tag</span> = ret.consumerTag
      )
    <span class="hljs-keyword">else</span>
      bb.<span class="hljs-keyword">try</span>( <span class="hljs-function">-&gt;</span> )

  <span class="hljs-attribute">restart</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span>: #restart rejected state <span class="hljs-subst">#{<span class="hljs-property">@state</span>}</span>"</span>) <span class="hljs-keyword">if</span> !<span class="hljs-property">@in_state</span>([<span class="hljs-string">'started'</span>])
    <span class="hljs-property">@change_state</span>(<span class="hljs-string">'restarting'</span>)
    <span class="hljs-property">@start</span>()

  <span class="hljs-attribute">start</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">return</span> bb.<span class="hljs-keyword">try</span>( <span class="hljs-function">-&gt;</span> <span class="hljs-literal">true</span>) <span class="hljs-keyword">if</span> <span class="hljs-property">@state</span> == <span class="hljs-string">'started'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>can only start from stopped or restarting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span>: #start rejected state <span class="hljs-subst">#{<span class="hljs-property">@state</span>}</span>"</span>) <span class="hljs-keyword">if</span>  !<span class="hljs-property">@in_state</span>([<span class="hljs-string">'stopped'</span>, <span class="hljs-string">'restarting'</span>])
    <span class="hljs-property">@change_state</span>(<span class="hljs-string">'starting'</span>)
    <span class="hljs-keyword">try</span>
      <span class="hljs-property">@get_service_channel</span>()
      .<span class="hljs-keyword">then</span>( <span class="hljs-function">=&gt;</span>
        <span class="hljs-property">@change_state</span>(<span class="hljs-string">'started'</span>)
      )
    <span class="hljs-keyword">catch</span> error
      bb.<span class="hljs-keyword">try</span>( <span class="hljs-function">-&gt;</span> <span class="hljs-keyword">throw</span> error) <span class="hljs-comment"># turn actual error into promise error</span>

  <span class="hljs-attribute">stop</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">return</span> bb.<span class="hljs-keyword">try</span>( <span class="hljs-function">-&gt;</span> <span class="hljs-literal">true</span>) <span class="hljs-keyword">if</span> <span class="hljs-property">@state</span> == <span class="hljs-string">'stopped'</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span>: #stop rejected state <span class="hljs-subst">#{<span class="hljs-property">@state</span>}</span>"</span>) <span class="hljs-keyword">if</span> !<span class="hljs-property">@in_state</span>([<span class="hljs-string">'started'</span>])
    bb.all([<span class="hljs-property">@get_service_channel</span>(), <span class="hljs-property">@get_connection</span>()])
    .spread( <span class="hljs-function"><span class="hljs-params">(channel, connection)</span> =&gt;</span>
      <span class="hljs-property">@change_state</span>(<span class="hljs-string">'stopping'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>stop receiving calls</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> <span class="hljs-property">@_service_queue_consumer_tag</span>
        stop = channel.cancel(<span class="hljs-property">@_service_queue_consumer_tag</span>)
      <span class="hljs-keyword">else</span>
        stop = bb.<span class="hljs-keyword">try</span>(<span class="hljs-function">-&gt;</span>)

      stop.<span class="hljs-keyword">then</span>( <span class="hljs-function">=&gt;</span>
        bb.all(_.values(<span class="hljs-property">@in_flight_messages</span>))
      )
      .<span class="hljs-keyword">then</span>( <span class="hljs-function">-&gt;</span>
        connection.close()
      )
    )
    .<span class="hljs-keyword">then</span>( <span class="hljs-function">=&gt;</span>
      <span class="hljs-property">@change_state</span>(<span class="hljs-string">'stopped'</span>)
    )

  <span class="hljs-attribute">in_state</span>: <span class="hljs-function"><span class="hljs-params">(states)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> states
      <span class="hljs-keyword">if</span> <span class="hljs-property">@state</span> == s
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

  <span class="hljs-attribute">change_state</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-property">@log</span> <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@state</span>}</span> -&gt; <span class="hljs-subst">#{state}</span>"</span>
    <span class="hljs-property">@state</span> = state

  <span class="hljs-attribute">kill</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span>: #kill rejected state <span class="hljs-subst">#{<span class="hljs-property">@state</span>}</span>"</span>) <span class="hljs-keyword">if</span> !<span class="hljs-property">@in_state</span>([<span class="hljs-string">'stopped'</span>,<span class="hljs-string">'started'</span>])
    <span class="hljs-property">@get_connection</span>()
    .<span class="hljs-keyword">then</span>( <span class="hljs-function"><span class="hljs-params">(connection)</span> =&gt;</span>
      <span class="hljs-property">@change_state</span>(<span class="hljs-string">'killing'</span>)
      connection.close()
    )
    .<span class="hljs-keyword">then</span>( <span class="hljs-function">=&gt;</span>
      <span class="hljs-property">@change_state</span>(<span class="hljs-string">'dead'</span>)
    )

  <span class="hljs-attribute">sendMessage</span>: <span class="hljs-function"><span class="hljs-params">(exchange, routing_key, payload, options)</span> -&gt;</span>
    <span class="hljs-property">@get_service_channel</span>()
    .<span class="hljs-keyword">then</span>( <span class="hljs-function"><span class="hljs-params">(service_channel)</span> =&gt;</span>
      service_channel.publish(exchange, routing_key, payload, options)
    )


<span class="hljs-built_in">module</span>.exports = ServiceConnectionManager</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
