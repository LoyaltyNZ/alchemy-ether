<!DOCTYPE html>

<html>
<head>
  <title>service.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="service.html">
                  service.coffee
                </a>
              
                
                <a class="source" href="service_connection_manager.html">
                  service_connection_manager.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>service.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>bb = <span class="hljs-built_in">require</span> <span class="hljs-string">"bluebird"</span>
msgpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'msgpack'</span>)
uuid = <span class="hljs-built_in">require</span> <span class="hljs-string">'node-uuid'</span>

ServiceConnectionManger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./service_connection_manager'</span>)
_ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageNotDeliveredError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Error</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(messageID, routingKey)</span> -&gt;</span>
    <span class="hljs-property">@name</span> = <span class="hljs-string">"MessageNotDeliveredError"</span>
    <span class="hljs-property">@message</span> = <span class="hljs-string">"message <span class="hljs-subst">#{messageID}</span> not delivered to <span class="hljs-subst">#{routingKey}</span>"</span>
    Error.captureStackTrace(<span class="hljs-keyword">this</span>, MessageNotDeliveredError)
<span class="hljs-function">
<span class="hljs-title">generateUUID</span> = -&gt;</span>
    uuid.v4().replace(<span class="hljs-regexp">/-/g</span>,<span class="hljs-string">''</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Service</span></span>
  <span class="hljs-property">@TimeoutError</span> = bb.TimeoutError
  <span class="hljs-property">@MessageNotDeliveredError</span> = MessageNotDeliveredError
  <span class="hljs-property">@NAckError</span> = ServiceConnectionManger.NAckError
  <span class="hljs-property">@generateUUID</span> = generateUUID


  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@name</span>, options = {})</span> -&gt;</span>
    <span class="hljs-property">@options</span> = _.defaults(
      options,
      {
        <span class="hljs-attribute">service_queue</span>: <span class="hljs-literal">true</span>
        <span class="hljs-attribute">response_queue</span>: <span class="hljs-literal">true</span>
        <span class="hljs-attribute">ampq_uri</span>: <span class="hljs-string">'amqp://localhost'</span>
        <span class="hljs-attribute">timeout</span>: <span class="hljs-number">1000</span>
        <span class="hljs-attribute">service_fn</span>:
          <span class="hljs-function"><span class="hljs-params">(payload)</span> -&gt;</span> {}
      }
    )
    <span class="hljs-keyword">throw</span> <span class="hljs-string">"Service Name undefined"</span> <span class="hljs-keyword">if</span> !<span class="hljs-property">@name</span>
    <span class="hljs-property">@uuid</span> = <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span>.<span class="hljs-subst">#{generateUUID()}</span>"</span>
    <span class="hljs-property">@transactions</span> = {}

    <span class="hljs-keyword">if</span> <span class="hljs-property">@options</span>.response_queue
      <span class="hljs-property">@response_queue_name</span> = <span class="hljs-property">@uuid</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@response_queue_name</span> = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">if</span> <span class="hljs-property">@options</span>.service_queue
      <span class="hljs-property">@service_queue_name</span> = <span class="hljs-property">@name</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@service_queue_name</span> = <span class="hljs-literal">null</span>

    <span class="hljs-property">@connection_manager</span> = <span class="hljs-keyword">new</span> ServiceConnectionManger(
      <span class="hljs-property">@options</span>.ampq_uri,
      <span class="hljs-property">@uuid</span>,
      <span class="hljs-property">@service_queue_name</span>,
      <span class="hljs-property">@receiveMessage</span>,
      <span class="hljs-property">@response_queue_name</span>,
      <span class="hljs-property">@processMessageResponse</span>,
      <span class="hljs-property">@processMessageReturned</span>
    )

  <span class="hljs-attribute">start</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@connection_manager</span>.start()


  <span class="hljs-attribute">stop</span>: <span class="hljs-function">-&gt;</span>
    transaction_promises = _.values(<span class="hljs-property">@transactions</span>).map( <span class="hljs-function"><span class="hljs-params">(tx)</span> -&gt;</span>
      tx.promise.<span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
        <span class="hljs-built_in">console</span>.log e
      )
    )

    <span class="hljs-keyword">if</span> transaction_promises.length &gt; <span class="hljs-number">0</span>
      bb.any(transaction_promises)
      .<span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
        <span class="hljs-built_in">console</span>.log e
      )
      .<span class="hljs-keyword">finally</span>( <span class="hljs-function">=&gt;</span>
        <span class="hljs-property">@connection_manager</span>.stop()
      )
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@connection_manager</span>.stop()

  <span class="hljs-attribute">kill</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@connection_manager</span>.kill()</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Send a message internally</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">sendMessageToService</span>: <span class="hljs-function"><span class="hljs-params">(service, payload)</span> -&gt;</span>
    <span class="hljs-property">@sendHttpRequestMessage</span>(<span class="hljs-string">''</span>, service, payload)

  <span class="hljs-attribute">sendHttpRequestMessage</span>: <span class="hljs-function"><span class="hljs-params">(exchange, service, payload)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Set Up Default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    http_payload = {
      <span class="hljs-attribute">session_id</span>:  payload.session_id
      <span class="hljs-attribute">scheme</span>:      payload.protocol    || <span class="hljs-string">'http'</span>
      <span class="hljs-attribute">host</span>:        payload.hostname    || <span class="hljs-string">'localhost'</span>
      <span class="hljs-attribute">port</span>:        payload.port        || <span class="hljs-number">8080</span>
      <span class="hljs-attribute">path</span>:        payload.path        || <span class="hljs-string">"/"</span>
      <span class="hljs-attribute">query</span>:       payload.query       || {}
      <span class="hljs-attribute">verb</span>:        payload.verb        || <span class="hljs-string">"GET"</span>
      <span class="hljs-attribute">headers</span>:     payload.headers     || {}
      <span class="hljs-attribute">body</span>:        payload.body        || <span class="hljs-string">""</span>
      <span class="hljs-attribute">log</span>:         payload.log         || {}
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>If an x-interaction-id header is present in the payload’s
headers we use it, otherwise generate one. The presence of an interaction
id indicates that this message originated internally since all external
http requests will be stripped</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> !http_payload.headers[<span class="hljs-string">'x-interaction-id'</span>]
      http_payload.headers[<span class="hljs-string">'x-interaction-id'</span>] = generateUUID()


    messageId = generateUUID()
    http_message_options =
      <span class="hljs-attribute">messageId</span>: messageId
      <span class="hljs-attribute">type</span>: <span class="hljs-string">'http_request'</span>
      <span class="hljs-attribute">replyTo</span>: <span class="hljs-property">@response_queue_name</span>
      <span class="hljs-attribute">contentEncoding</span>: <span class="hljs-string">'8bit'</span>
      <span class="hljs-attribute">contentType</span>: <span class="hljs-string">'application/octet-stream'</span>
      <span class="hljs-attribute">expiration</span>: <span class="hljs-property">@options</span>.timeout</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>create the returned_promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    deferred = {}
    returned_promise = <span class="hljs-keyword">new</span> bb( <span class="hljs-function"><span class="hljs-params">(resolve, reject)</span> -&gt;</span>
      deferred.resolve_promise = resolve
      deferred.reject_promise = reject
    )
    deferred.promise = returned_promise

    <span class="hljs-property">@transactions</span>[messageId] = deferred

    returned_promise = returned_promise.timeout(<span class="hljs-property">@options</span>.timeout)

    returned_promise.timeout(<span class="hljs-property">@options</span>.timeout)
    .<span class="hljs-keyword">catch</span>(bb.TimeoutError, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> returned_promise.isFulfilled() <span class="hljs-comment">#Under stress the error can be thrown when already resolved</span>
      <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span>: Timeout for message ID `<span class="hljs-subst">#{messageId}</span>`"</span>
      <span class="hljs-keyword">throw</span> err
    )
    .<span class="hljs-keyword">catch</span>(Service.MessageNotDeliveredError, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
      <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span>: MessageNotDeliveredError for message ID `<span class="hljs-subst">#{messageId}</span>`"</span>
      <span class="hljs-keyword">throw</span> err
    )
    .<span class="hljs-keyword">finally</span>( <span class="hljs-function">=&gt;</span>
      <span class="hljs-keyword">delete</span> <span class="hljs-property">@transactions</span>[messageId]
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>seperate out</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    message_promise = <span class="hljs-property">@sendMessage</span>(exchange, service, http_payload, http_message_options)
    .<span class="hljs-keyword">then</span>( <span class="hljs-function">=&gt;</span>
      returned_promise
    )

    message_promise.messageId = messageId
    message_promise.transactionId = http_payload.headers[<span class="hljs-string">'x-interaction-id'</span>]
    message_promise.response_queue_name = <span class="hljs-property">@response_queue_name</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Send the message on the queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    message_promise

  <span class="hljs-attribute">processMessageReturned</span>: <span class="hljs-function"><span class="hljs-params">(msg)</span> =&gt;</span>
    deferred = <span class="hljs-property">@transactions</span>[msg?.properties?.messageId]
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> deferred
    <span class="hljs-keyword">return</span> deferred.reject_promise(<span class="hljs-keyword">new</span> Service.MessageNotDeliveredError(msg?.properties?.messageId, msg?.fields?.routingKey))

  <span class="hljs-attribute">processMessageResponse</span>: <span class="hljs-function"><span class="hljs-params">(msg)</span> =&gt;</span>
    deferred = <span class="hljs-property">@transactions</span>[msg.properties.correlationId]
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> deferred? <span class="hljs-keyword">or</span> msg.properties.type != <span class="hljs-string">'http_response'</span>
      <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span>: Received Unsolicited Response message ID `<span class="hljs-subst">#{msg.properties.messageId}</span>`,
      correlationId: `<span class="hljs-subst">#{msg.properties.correlationId}</span>`
      type '<span class="hljs-subst">#{msg.properties.type}</span>'"</span>
      deferred.reject_promise(<span class="hljs-string">"Property type wrong"</span>) <span class="hljs-keyword">if</span> deferred
      <span class="hljs-keyword">return</span>

    deferred.resolve_promise([msg, msgpack.unpack(msg.content)])

  <span class="hljs-attribute">receiveMessage</span>: <span class="hljs-function"><span class="hljs-params">(msg)</span> =&gt;</span>
    type = msg.properties.type
    <span class="hljs-keyword">if</span> type == <span class="hljs-string">'http_request'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-property">@receiveHTTPRequest</span>(msg)
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@receiveUtilityEvent</span>(msg)

  <span class="hljs-attribute">receiveUtilityEvent</span>: <span class="hljs-function"><span class="hljs-params">(msg)</span> -&gt;</span>
    type = msg.properties.type

    <span class="hljs-keyword">if</span> msg.content
      payload = msgpack.unpack(msg.content)
    <span class="hljs-keyword">else</span>
      payload = {}

    bb.<span class="hljs-keyword">try</span>( <span class="hljs-function">=&gt;</span>
      <span class="hljs-property">@options</span>.service_fn(payload)
    ).<span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span> UTILITY_ERROR from message type <span class="hljs-subst">#{type}</span>"</span>, err.stack
      <span class="hljs-keyword">throw</span> err <span class="hljs-comment">#Propagate up the stack</span>
    )

  <span class="hljs-attribute">receiveHTTPRequest</span>: <span class="hljs-function"><span class="hljs-params">(msg)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> msg.content
      payload = msgpack.unpack(msg.content)
    <span class="hljs-keyword">else</span>
      payload = {<span class="hljs-attribute">body</span>: {}, <span class="hljs-attribute">headers</span>: {}}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>response info</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    service_to_reply_to = msg.properties.replyTo
    message_replying_to = msg.properties.messageId
    this_message_id = generateUUID()

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (service_to_reply_to <span class="hljs-keyword">and</span> message_replying_to)
      <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span>: Received message with no ID and/or Reply type'"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>process the message
TODO log incoming call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    bb.<span class="hljs-keyword">try</span>( <span class="hljs-function">=&gt;</span>
      <span class="hljs-property">@options</span>.service_fn(payload)
    )
    .<span class="hljs-keyword">then</span>( <span class="hljs-function"><span class="hljs-params">(response = {})</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>service function must return a response object with
{
  body:
  status_code:
  headers: {}
}</p>
<ol>
<li>JSON body</li>
<li>RESPONSE Object
3.
reply if the information is there</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      resp = {
        <span class="hljs-attribute">status_code</span>:  response.status_code || <span class="hljs-number">200</span>
        <span class="hljs-attribute">headers</span>: response.headers || { <span class="hljs-string">'x-interaction-id'</span>: payload.headers[<span class="hljs-string">'x-interaction-id'</span>]}
        <span class="hljs-attribute">body</span>: response.body || {}
      }

      <span class="hljs-property">@replyToServiceMessage</span>(
        service_to_reply_to,
        resp,
        {
          <span class="hljs-attribute">type</span>: <span class="hljs-string">'http_response'</span>,
          <span class="hljs-attribute">correlationId</span>: message_replying_to,
          <span class="hljs-attribute">messageId</span>: this_message_id
        }
      )
    ).<span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@uuid</span>}</span> HTTP_ERROR"</span>, err.stack
      resp = {
        <span class="hljs-attribute">status_code</span>: <span class="hljs-number">500</span>
        <span class="hljs-attribute">headers</span>: {
          <span class="hljs-string">'x-interaction-id'</span>: payload.headers[<span class="hljs-string">'x-interaction-id'</span>]
        }
        <span class="hljs-attribute">body</span>: {
          <span class="hljs-attribute">code</span>: <span class="hljs-string">'service.fault'</span>
          <span class="hljs-attribute">message</span>: <span class="hljs-string">'An unexpected error occurred'</span>
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>If all else fails</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@replyToServiceMessage</span>(
        service_to_reply_to,
        resp,
        {
          <span class="hljs-attribute">type</span>: <span class="hljs-string">'http_response'</span>,
          <span class="hljs-attribute">correlationId</span>: message_replying_to,
          <span class="hljs-attribute">messageId</span>: this_message_id
        }
      )

      <span class="hljs-keyword">throw</span> err <span class="hljs-comment"># reraise the error to the service channel layer</span>
    )

  <span class="hljs-attribute">replyToServiceMessage</span>: <span class="hljs-function"><span class="hljs-params">(response_queue, payload, options)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>directly respond to message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@sendMessage</span>(<span class="hljs-string">''</span>, response_queue, payload, options)

  <span class="hljs-attribute">sendMessage</span>: <span class="hljs-function"><span class="hljs-params">(exchange, service, payload, options)</span> -&gt;</span>
    options.mandatory = <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> options.type == <span class="hljs-string">'http_request'</span>
    <span class="hljs-property">@connection_manager</span>.sendMessage(exchange, service, msgpack.pack(payload), options)


<span class="hljs-built_in">module</span>.exports = Service</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
